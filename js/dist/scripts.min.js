var G3=G3||{lib:{globeScale:1e-5,imageSources:{black:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAAAAABX3VL4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAAE0lEQVR42mJgYAAIIAYGBoAAAwAABgABfQjGZwAAAABJRU5ErkJggg==",error:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAAAAABX3VL4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAAE0lEQVR42mJgYAAIIAYGBoAAAwAABgABfQjGZwAAAABJRU5ErkJggg=="}},setLib:function(i){i=i||{},this.lib=Object.assign({},this.lib,i)}};G3.GlobeTiles=function(i,t,e){this.lib=G3.lib,this.type="G3.GlobeTiles",this.options={tilesUpdatable:!0,tilesRemovable:!0,tiling:[-180,84,8,8]},this.tiles=[],this.init(i,t,e)},G3.GlobeTiles.prototype.init=function(i,t,e){this.group=null,this.groupName=this.type,this.groupContainer=i||null,this.tiles=[],this.valid=this.validate(),this.valid&&(this.setOptions(e),this.requestTiles(t))},G3.GlobeTiles.prototype.validate=function(){return this.groupContainer?"Group"==this.groupContainer.type||"Scene"==this.groupContainer.type||(console.warn("G3.GlobeTiles: container.type wrong"),!1):(console.warn("G3.GlobeTiles: container undefined"),!1)},G3.GlobeTiles.prototype.setOptions=function(i){i=i||{},this.options=Object.assign({},this.options,i)},G3.GlobeTiles.prototype.requestTiles=function(i){if(i=i||null)if(Array.isArray(i))for(var t=0;t<i.length;t++)this.requestTile(i[t]);else this.requestTile(i)},G3.GlobeTiles.prototype.requestTile=function(i){if(i){var t=this;this.promiseTile(i).then(function(i){console.log("promise resolved"),t.putTile(i)},function(i){console.warn("G3.GlobeTiles.addTile failed","(",i,")")})}},G3.GlobeTiles.prototype.promiseTile=function(i){var t=this.options.tiling;return new Promise(function(e,s){var r=new G3.Tile(t);r.onReady=function(i){e(i)},r.onError=function(i){s(i)},r.loadTile(i)})},G3.GlobeTiles.prototype.putTile=function(i){console.log(i.id),this.tiles[i.id]&&!this.options.tilesUpdatable?console.warn(this.type,"Tile already exists and tiles are not updatable"):this.tiles[i.id]=i,console.dir(this.tiles)},G3.Tile=function(i){this.lib=G3.lib,this.type="G3.Tile",this.state="init",this.id=null,this.area=null,this.data=null,this.tiling=i||[-180,84,8,8]},G3.Tile.prototype.loadTile=function(i){if(i=i||{},"string"==typeof i)return void this.loadTile_fromUrl(i);if(this.area=i.area||null,this.data=i.data||{topo:{url:this.lib.imageSources.black},alti:{url:this.lib.imageSources.black,transform:[0,1]}},"undefined"==typeof this.data.topo&&(this.data.topo={url:this.lib.imageSources.black}),"undefined"==typeof this.data.alti&&(this.data.alti={url:this.lib.imageSources.black,transform:[0,1]}),"undefined"==typeof this.data.alti.transform&&(this.data.alti.transform=[0,1]),this.valid=this.validate(),this.valid.error)return this.state="error",void this.onError(this.valid.error);this.id=this.valid.id;var t=0;for(var e in this.data)this.data[e].url&&t++;if(this.state=t,this.state>0)for(var e in this.data)this.data[e].url&&this.loadImageSources(this.data[e],this);else this.state="ready",this.onReady(this)},G3.Tile.prototype.loadTile_fromUrl=function(i){var t=this,e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var e=JSON.parse(this.responseText);t.loadTile(e)}else t.onError("file "+this.status+": "+i)},e.open("GET",i,!0),e.send()},G3.Tile.prototype.validate=function(){if(!Array.isArray(this.tiling)||this.tiling.length<4)return{error:"tiling-info insufficient"};if(!Array.isArray(this.area)||this.area.length<4)return{error:"area-info insufficient"};if(this.tiling[2]!=this.area[2]||this.tiling[3]!=this.area[3])return{error:"tile-size and tiling-size are different"};var i=(this.area[0]-this.tiling[0])/this.area[2],t=(this.tiling[1]-this.area[1])/this.area[3]-1,e=360/this.area[2];return i%1===0&&t%1===0?{id:i+t*e}:{error:"tile does not fit in tiling"}},G3.Tile.prototype.loadImageSources=function(i,t){i.img=new Image,i.img.onload=function(){t.state-=1,t.onProgress()},i.img.onerror=function(){this.srcFailed=this.src,this.src=t.lib.imageSources.error},i.img.src=i.url},G3.Tile.prototype.onProgress=function(){"ready"!=this.state&&"error"!=this.state&&0===this.state&&(this.state="ready",this.onReady(this))},G3.Tile.prototype.onReady=function(i){},G3.Tile.prototype.onError=function(i){},G3.Tile=function(i){this.lib=G3.lib,this.type="G3.Tile",this.state="init",this.id=null,this.area=null,this.data=null,this.tiling=i||[-180,84,8,8]},G3.Tile.prototype.loadTile=function(i){if(i=i||{},"string"==typeof i)return void this.loadTile_fromUrl(i);if(this.area=i.area||null,this.data=i.data||{topo:{url:this.lib.imageSources.black},alti:{url:this.lib.imageSources.black,transform:[0,1]}},"undefined"==typeof this.data.topo&&(this.data.topo={url:this.lib.imageSources.black}),"undefined"==typeof this.data.alti&&(this.data.alti={url:this.lib.imageSources.black,transform:[0,1]}),"undefined"==typeof this.data.alti.transform&&(this.data.alti.transform=[0,1]),this.valid=this.validate(),this.valid.error)return this.state="error",void this.onError(this.valid.error);this.id=this.valid.id;var t=0;for(var e in this.data)this.data[e].url&&t++;if(this.state=t,this.state>0)for(var e in this.data)this.data[e].url&&this.loadImageSources(this.data[e],this);else this.state="ready",this.onReady(this)},G3.Tile.prototype.loadTile_fromUrl=function(i){var t=this,e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var e=JSON.parse(this.responseText);t.loadTile(e)}else t.onError("file "+this.status+": "+i)},e.open("GET",i,!0),e.send()},G3.Tile.prototype.validate=function(){if(!Array.isArray(this.tiling)||this.tiling.length<4)return{error:"tiling-info insufficient"};if(!Array.isArray(this.area)||this.area.length<4)return{error:"area-info insufficient"};if(this.tiling[2]!=this.area[2]||this.tiling[3]!=this.area[3])return{error:"tile-size and tiling-size are different"};var i=(this.area[0]-this.tiling[0])/this.area[2],t=(this.tiling[1]-this.area[1])/this.area[3]-1,e=360/this.area[2];return i%1===0&&t%1===0?{id:i+t*e}:{error:"tile does not fit in tiling"}},G3.Tile.prototype.loadImageSources=function(i,t){i.img=new Image,i.img.onload=function(){t.state-=1,t.onProgress()},i.img.onerror=function(){this.srcFailed=this.src,this.src=t.lib.imageSources.error},i.img.src=i.url},G3.Tile.prototype.onProgress=function(){"ready"!=this.state&&"error"!=this.state&&0===this.state&&(this.state="ready",this.onReady(this))},G3.Tile.prototype.onReady=function(i){},G3.Tile.prototype.onError=function(i){},G3.TileLayer=function(i,t,e){this.lib=G3.lib,this.type="G3.TileLayer",this.options={tilesUpdatable:!0,tilesRemovable:!0,tiling:[-180,84,8,8]},this.tiles=[],this.init(i,t,e)},G3.TileLayer.prototype.init=function(i,t,e){this.group=null,this.groupName=this.type,this.groupContainer=i||null,this.tiles=[],this.valid=this.validate(),this.valid&&(this.setOptions(e),this.requestTiles(t))},G3.TileLayer.prototype.validate=function(){return this.groupContainer?"Group"==this.groupContainer.type||"Scene"==this.groupContainer.type||(console.warn("G3.TileLayer: container.type wrong"),!1):(console.warn("G3.TileLayer: container undefined"),!1)},G3.TileLayer.prototype.setOptions=function(i){i=i||{},this.options=Object.assign({},this.options,i)},G3.TileLayer.prototype.requestTiles=function(i){if(i=i||null)if(Array.isArray(i))for(var t=0;t<i.length;t++)this.requestTile(i[t]);else this.requestTile(i)},G3.TileLayer.prototype.requestTile=function(i){if(i){var t=this;this.promiseTile(i).then(function(i){console.log("promise resolved"),t.putTile(i)},function(i){console.warn("G3.TileLayer.addTile failed","(",i,")")})}},G3.TileLayer.prototype.promiseTile=function(i){var t=this.options.tiling;return new Promise(function(e,s){var r=new G3.Tile(t);r.onReady=function(i){e(i)},r.onError=function(i){s(i)},r.loadTile(i)})},G3.TileLayer.prototype.putTile=function(i){console.log(i.id),this.tiles[i.id]&&!this.options.tilesUpdatable?console.warn(this.type,"Tile already exists and tiles are not updatable"):this.tiles[i.id]=i,console.dir(this.tiles)};